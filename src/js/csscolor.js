    var CSS = {};
    
    var // utils
        round = Math.round, floor = Math.floor, min = Math.min, max = Math.max, abs = Math.abs,
        
        clamp = function(v, m, M) { return max(min(v, M), m); },
        
        esc = function(s) { return s.replace(/([.*+?^${}()|\[\]\/\\\-])/g, '\\$1'); },
        
        trim = function(s) { return s.replace(/^\s+/gm, '').replace(/\s+$/gm, ''); },
        
    ;
    
    //
    // CSS Color Class and utils
    var Color = CSS.Color = function( color, cstop ) {
        // constructor factory pattern used here also
        if ( this instanceof CSS.Color ) 
        {
            this.reset();
            if ( color ) this.set( color, cstop );
        } 
        else 
        {
            return new CSS.Color( color, cstop );
        }
    };
    //
    // static
    Color.Keywords = {
        // http://www.w3.org/wiki/CSS/Properties/color/keywords
        // https://developer.mozilla.org/en-US/docs/Web/CSS/color_value
        /* extended */
        'transparent'         : [  0,0,0        ,0]
        ,'aliceblue'           : [  240,248,255  ,1]
        ,'antiquewhite'        : [  250,235,215  ,1]
        ,'aqua'                : [  0,255,255    ,1]
        ,'aquamarine'          : [  127,255,212  ,1]
        ,'azure'               : [  240,255,255  ,1]
        ,'beige'               : [  245,245,220  ,1]
        ,'bisque'              : [  255,228,196  ,1]
        ,'black'               : [  0,0,0    ,    1]
        ,'blanchedalmond'      : [  255,235,205  ,1]
        ,'blue'                : [  0,0,255  ,    1]
        ,'blueviolet'          : [  138,43,226   ,1]
        ,'brown'               : [  165,42,42    ,1]
        ,'burlywood'           : [  222,184,135  ,1]
        ,'cadetblue'           : [  95,158,160   ,1]
        ,'chartreuse'          : [  127,255,0    ,1]
        ,'chocolate'           : [  210,105,30   ,1]
        ,'coral'               : [  255,127,80   ,1]
        ,'cornflowerblue'      : [  100,149,237  ,1]
        ,'cornsilk'            : [  255,248,220  ,1]
        ,'crimson'             : [  220,20,60    ,1]
        ,'cyan'                : [  0,255,255    ,1]
        ,'darkblue'            : [  0,0,139  ,    1]
        ,'darkcyan'            : [  0,139,139    ,1]
        ,'darkgoldenrod'       : [  184,134,11   ,1]
        ,'darkgray'            : [  169,169,169  ,1]
        ,'darkgreen'           : [  0,100,0  ,    1]
        ,'darkgrey'            : [  169,169,169  ,1]
        ,'darkkhaki'           : [  189,183,107  ,1]
        ,'darkmagenta'         : [  139,0,139    ,1]
        ,'darkolivegreen'      : [  85,107,47    ,1]
        ,'darkorange'          : [  255,140,0    ,1]
        ,'darkorchid'          : [  153,50,204   ,1]
        ,'darkred'             : [  139,0,0  ,    1]
        ,'darksalmon'          : [  233,150,122  ,1]
        ,'darkseagreen'        : [  143,188,143  ,1]
        ,'darkslateblue'       : [  72,61,139    ,1]
        ,'darkslategray'       : [  47,79,79 ,    1]
        ,'darkslategrey'       : [  47,79,79 ,    1]
        ,'darkturquoise'       : [  0,206,209    ,1]
        ,'darkviolet'          : [  148,0,211    ,1]
        ,'deeppink'            : [  255,20,147   ,1]
        ,'deepskyblue'         : [  0,191,255    ,1]
        ,'dimgray'             : [  105,105,105  ,1]
        ,'dimgrey'             : [  105,105,105  ,1]
        ,'dodgerblue'          : [  30,144,255   ,1]
        ,'firebrick'           : [  178,34,34    ,1]
        ,'floralwhite'         : [  255,250,240  ,1]
        ,'forestgreen'         : [  34,139,34    ,1]
        ,'fuchsia'             : [  255,0,255    ,1]
        ,'gainsboro'           : [  220,220,220  ,1]
        ,'ghostwhite'          : [  248,248,255  ,1]
        ,'gold'                : [  255,215,0    ,1]
        ,'goldenrod'           : [  218,165,32   ,1]
        ,'gray'                : [  128,128,128  ,1]
        ,'green'               : [  0,128,0  ,    1]
        ,'greenyellow'         : [  173,255,47   ,1]
        ,'grey'                : [  128,128,128  ,1]
        ,'honeydew'            : [  240,255,240  ,1]
        ,'hotpink'             : [  255,105,180  ,1]
        ,'indianred'           : [  205,92,92    ,1]
        ,'indigo'              : [  75,0,130 ,    1]
        ,'ivory'               : [  255,255,240  ,1]
        ,'khaki'               : [  240,230,140  ,1]
        ,'lavender'            : [  230,230,250  ,1]
        ,'lavenderblush'       : [  255,240,245  ,1]
        ,'lawngreen'           : [  124,252,0    ,1]
        ,'lemonchiffon'        : [  255,250,205  ,1]
        ,'lightblue'           : [  173,216,230  ,1]
        ,'lightcoral'          : [  240,128,128  ,1]
        ,'lightcyan'           : [  224,255,255  ,1]
        ,'lightgoldenrodyellow': [  250,250,210  ,1]
        ,'lightgray'           : [  211,211,211  ,1]
        ,'lightgreen'          : [  144,238,144  ,1]
        ,'lightgrey'           : [  211,211,211  ,1]
        ,'lightpink'           : [  255,182,193  ,1]
        ,'lightsalmon'         : [  255,160,122  ,1]
        ,'lightseagreen'       : [  32,178,170   ,1]
        ,'lightskyblue'        : [  135,206,250  ,1]
        ,'lightslategray'      : [  119,136,153  ,1]
        ,'lightslategrey'      : [  119,136,153  ,1]
        ,'lightsteelblue'      : [  176,196,222  ,1]
        ,'lightyellow'         : [  255,255,224  ,1]
        ,'lime'                : [  0,255,0  ,    1]
        ,'limegreen'           : [  50,205,50    ,1]
        ,'linen'               : [  250,240,230  ,1]
        ,'magenta'             : [  255,0,255    ,1]
        ,'maroon'              : [  128,0,0  ,    1]
        ,'mediumaquamarine'    : [  102,205,170  ,1]
        ,'mediumblue'          : [  0,0,205  ,    1]
        ,'mediumorchid'        : [  186,85,211   ,1]
        ,'mediumpurple'        : [  147,112,219  ,1]
        ,'mediumseagreen'      : [  60,179,113   ,1]
        ,'mediumslateblue'     : [  123,104,238  ,1]
        ,'mediumspringgreen'   : [  0,250,154    ,1]
        ,'mediumturquoise'     : [  72,209,204   ,1]
        ,'mediumvioletred'     : [  199,21,133   ,1]
        ,'midnightblue'        : [  25,25,112    ,1]
        ,'mintcream'           : [  245,255,250  ,1]
        ,'mistyrose'           : [  255,228,225  ,1]
        ,'moccasin'            : [  255,228,181  ,1]
        ,'navajowhite'         : [  255,222,173  ,1]
        ,'navy'                : [  0,0,128  ,    1]
        ,'oldlace'             : [  253,245,230  ,1]
        ,'olive'               : [  128,128,0    ,1]
        ,'olivedrab'           : [  107,142,35   ,1]
        ,'orange'              : [  255,165,0    ,1]
        ,'orangered'           : [  255,69,0 ,    1]
        ,'orchid'              : [  218,112,214  ,1]
        ,'palegoldenrod'       : [  238,232,170  ,1]
        ,'palegreen'           : [  152,251,152  ,1]
        ,'paleturquoise'       : [  175,238,238  ,1]
        ,'palevioletred'       : [  219,112,147  ,1]
        ,'papayawhip'          : [  255,239,213  ,1]
        ,'peachpuff'           : [  255,218,185  ,1]
        ,'peru'                : [  205,133,63   ,1]
        ,'pink'                : [  255,192,203  ,1]
        ,'plum'                : [  221,160,221  ,1]
        ,'powderblue'          : [  176,224,230  ,1]
        ,'purple'              : [  128,0,128    ,1]
        ,'red'                 : [  255,0,0  ,    1]
        ,'rosybrown'           : [  188,143,143  ,1]
        ,'royalblue'           : [  65,105,225   ,1]
        ,'saddlebrown'         : [  139,69,19    ,1]
        ,'salmon'              : [  250,128,114  ,1]
        ,'sandybrown'          : [  244,164,96   ,1]
        ,'seagreen'            : [  46,139,87    ,1]
        ,'seashell'            : [  255,245,238  ,1]
        ,'sienna'              : [  160,82,45    ,1]
        ,'silver'              : [  192,192,192  ,1]
        ,'skyblue'             : [  135,206,235  ,1]
        ,'slateblue'           : [  106,90,205   ,1]
        ,'slategray'           : [  112,128,144  ,1]
        ,'slategrey'           : [  112,128,144  ,1]
        ,'snow'                : [  255,250,250  ,1]
        ,'springgreen'         : [  0,255,127    ,1]
        ,'steelblue'           : [  70,130,180   ,1]
        ,'tan'                 : [  210,180,140  ,1]
        ,'teal'                : [  0,128,128    ,1]
        ,'thistle'             : [  216,191,216  ,1]
        ,'tomato'              : [  255,99,71    ,1]
        ,'turquoise'           : [  64,224,208   ,1]
        ,'violet'              : [  238,130,238  ,1]
        ,'wheat'               : [  245,222,179  ,1]
        ,'white'               : [  255,255,255  ,1]
        ,'whitesmoke'          : [  245,245,245  ,1]
        ,'yellow'              : [  255,255,0    ,1]
        ,'yellowgreen'         : [  154,205,50   ,1]    
    };          
    Color.clamp = clamp;
    var C2F = Color.C2F = 1/255;
    var C2P = Color.C2P = 100/255;
    var P2C = Color.P2C = 2.55;
    // color format regexes
    Color.hexieRE = /^#([0-9a-fA-F]{8})\b/;
    Color.hexRE = /^#([0-9a-fA-F]{3,6})\b/;
    Color.rgbRE = /^(rgba?)\b\s*\(([^\)]*)\)/i;
    Color.hslRE = /^(hsla?)\b\s*\(([^\)]*)\)/i;
    Color.keywordRE = new RegExp('^(' + Object.keys(Color.Keywords).map(esc).join('|') + ')\\b', 'i');
    Color.colorstopRE = /^\s+(\d+(\.\d+)?%?)/;
    // color format conversions
    // http://www.rapidtables.com/convert/color/index.htm
    var col2per = Color.col2per = function(c, suffix) {
        return (c*C2P)+(suffix||'');
    };
    var per2col = Color.per2col = function(c) {
        return c*P2C;
    };
    // http://www.javascripter.net/faq/rgb2cmyk.htm
    var rgb2cmyk = Color.rgb2cmyk = function(r, g, b, asPercent) {
        var c = 0, m = 0, y = 0, k = 0,
            minCMY, invCMY
        ;

        if ( asPercent )
        {
            r = clamp(round(r*P2C), 0, 255);
            g = clamp(round(g*P2C), 0, 255);
            b = clamp(round(b*P2C), 0, 255);
        }
        
        // BLACK
        if ( 0==r && 0==g && 0==b ) 
        {
            k = 1;
            return [0, 0, 0, 1];
        }

        c = 1 - (r*C2F);
        m = 1 - (g*C2F);
        y = 1 - (b*C2F);

        minCMY = min( c, m, y );
        invCMY = 1 / (1 - minCMY);
        c = (c - minCMY) * invCMY;
        m = (m - minCMY) * invCMY;
        y = (y - minCMY) * invCMY;
        k = minCMY;

        return [c, m, y, k];
    };
    var cmyk2rgb = Color.cmyk2rgb = function(c, m, y, k) {
        var r = 0, g = 0, b = 0,
            minCMY, invCMY
        ;

        // BLACK
        if ( 0==c && 0==m && 0==y ) 
        {
            return [0, 0, 0];
        }
        
        minCMY = k;
        invCMY = 1 - minCMY;
        c = c*invCMY + minCMY;
        m = m*invCMY + minCMY;
        y = y*invCMY + minCMY;
        
        r = (1 - c)*255;
        g = (1 - m)*255;
        b = (1 - y)*255;

        return [
            clamp(round(r), 0, 255),
            clamp(round(g), 0, 255),
            clamp(round(b), 0, 255)
        ];
    };
    var rgb2hex = Color.rgb2hex = function(r, g, b, condenced, asPercent) { 
        var hex;
        if ( asPercent )
        {
            r = clamp(round(r*P2C), 0, 255);
            g = clamp(round(g*P2C), 0, 255);
            b = clamp(round(b*P2C), 0, 255);
        }
        
        r = ( r < 16 ) ? '0'+r.toString(16) : r.toString(16);
        g = ( g < 16 ) ? '0'+g.toString(16) : g.toString(16);
        b = ( b < 16 ) ? '0'+b.toString(16) : b.toString(16);
        
        if ( condenced && (r[0]==r[1] && g[0]==g[1] && b[0]==b[1]) )
            hex = '#' + r[0] + g[0] + b[0];
        else
            hex = '#' + r + g + b;
        
        return hex;
    };
    var rgb2hexIE = Color.rgb2hexIE = function(r, g, b, a, asPercent) { 
        var hex;
        if ( asPercent )
        {
            r = clamp(round(r*P2C), 0, 255);
            g = clamp(round(g*P2C), 0, 255);
            b = clamp(round(b*P2C), 0, 255);
            a = clamp(round(a*P2C), 0, 255);
        }
        
        r = ( r < 16 ) ? '0'+r.toString(16) : r.toString(16);
        g = ( g < 16 ) ? '0'+g.toString(16) : g.toString(16);
        b = ( b < 16 ) ? '0'+b.toString(16) : b.toString(16);
        a = ( a < 16 ) ? '0'+a.toString(16) : a.toString(16);
        hex = '#' + a + r + g + b;
        
        return hex;
    };
    var hex2rgb = Color.hex2rgb = function(h/*, asPercent*/) {  
        if ( !h || 3 > h.length )
            return [0, 0, 0];
            
        if ( 6 > h.length )
            return [
                clamp( parseInt(h[0]+h[0], 16), 0, 255 ), 
                clamp( parseInt(h[1]+h[1], 16), 0, 255 ), 
                clamp( parseInt(h[2]+h[2], 16), 0, 255 )
            ];
        
        else
            return [
                clamp( parseInt(h[0]+h[1], 16), 0, 255 ), 
                clamp( parseInt(h[2]+h[3], 16), 0, 255 ), 
                clamp( parseInt(h[4]+h[5], 16), 0, 255 )
            ];
        
        /*if ( asPercent )
            rgb = [
                (rgb[0]*C2P)+'%', 
                (rgb[1]*C2P)+'%', 
                (rgb[2]*C2P)+'%'
            ];*/
    };
    // http://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion
    /**
     * Converts an HSL color value to RGB. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
     * Assumes h, s, and l are contained in the set [0, 1] and
     * returns r, g, and b in the set [0, 255].
     */
    var hue2rgb = Color.hue2rgb = function(p, q, t) {
        if ( t < 0 ) t += 1;
        if ( t > 1 ) t -= 1;
        if ( t < 1/6 ) return p + (q - p) * 6 * t;
        if ( t < 1/2 ) return q;
        if ( t < 2/3 ) return p + (q - p) * (2/3 - t) * 6;
        return p;
    };
    var hsl2rgb = Color.hsl2rgb = function(h, s, l) {
        var r, g, b, p, q;

        // convert to [0, 1] range
        h = ((h + 360)%360)/360;
        s *= 0.01;
        l *= 0.01;
        
        if ( 0 == s )
        {
            // achromatic
            r = 1;
            g = 1;
            b = 1;
        }
        else
        {

            q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }

        return [
            clamp( round(r * 255), 0, 255 ), 
            clamp( round(g * 255), 0, 255 ),  
            clamp( round(b * 255), 0, 255 )
        ];
    };
    /**
    * Converts an RGB color value to HSL. Conversion formula
    * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
    * Assumes r, g, and b are contained in the set [0, 255] and
    * returns h, s, and l in the set [0, 1].
    */
    var rgb2hsl = Color.rgb2hsl = function(r, g, b, asPercent) {
        var m, M, h, s, l, d;
        
        if ( asPercent )
        {
            r *= 0.01;
            g *= 0.01;
            b *= 0.01;
        }
        else
        {
            r *= C2F; 
            g *= C2F; 
            b *= C2F;
        }
        M = max(r, g, b); 
        m = min(r, g, b);
        l = 0.5*(M + m);

        if ( M == m )
        {
            h = s = 0; // achromatic
        }
        else
        {
            d = M - m;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            
            if ( M == r )
                h = (g - b) / d + (g < b ? 6 : 0);
            
            else if ( M == g )
                h = (b - r) / d + 2;
            
            else
                h = (r - g) / d + 4;
            
            h /= 6;
        }
        
        return [
            round( h*360 ) % 360, 
            clamp(s*100, 0, 100), 
            clamp(l*100, 0, 100)
        ];
    };
    Color.parse = function(s, withColorStops, parsed, onlyColor) {
        var m, m2, s2, end = 0, end2 = 0, c, hasOpacity;
        
        if ( 'hsl' == parsed || 
            ( !parsed && (m = s.match(Color.hslRE)) ) 
        )
        {
            // hsl(a)
            if ( 'hsl' == parsed )
            {
                hasOpacity = 'hsla' == s[0].toLowerCase();
                var col = s[1].split(',').map(trim);
            }
            else
            {
                end = m[0].length;
                end2 = 0;
                hasOpacity = 'hsla' == m[1].toLowerCase();
                var col = m[2].split(',').map(trim);
            }    
            
            var h = col[0] ? col[0] : '0';
            var s = col[1] ? col[1] : '0';
            var l = col[2] ? col[2] : '0';
            var a = hasOpacity && null!=col[3] ? col[3] : '1';
            
            h = parseFloat(h, 10);
            s = ('%'==s.slice(-1)) ? parseFloat(s, 10) : parseFloat(s, 10)*C2P;
            l = ('%'==l.slice(-1)) ? parseFloat(l, 10) : parseFloat(l, 10)*C2P;
            a = parseFloat(a, 10);
            
            c = new Color().fromHSL([h, s, l, a]);

            if ( withColorStops )
            {
                s2 = s.substr( end );
                if ( m2 = s2.match(Color.colorstopRE) )
                {
                    c.colorStop( m2[1] );
                    end2 = m2[0].length;
                }
            }
            return onlyColor ? c : [c, 0, end+end2];
        }
        if ( 'rgb' == parsed || 
            ( !parsed && (m = s.match(Color.rgbRE)) ) 
        )
        {
            // rgb(a)
            if ( 'rgb' == parsed )
            {
                hasOpacity = 'rgba' == s[0].toLowerCase();
                var col = s[1].split(',').map(trim);
            }
            else
            {
                end = m[0].length;
                end2 = 0;
                hasOpacity = 'rgba' == m[1].toLowerCase();
                var col = m[2].split(',').map(trim);
            }    
                
            var r = col[0] ? col[0] : '0';
            var g = col[1] ? col[1] : '0';
            var b = col[2] ? col[2] : '0';
            var a = hasOpacity && null!=col[3] ? col[3] : '1';
            
            r = ('%'==r.slice(-1)) ? parseFloat(r, 10)*2.55 : parseFloat(r, 10);
            g = ('%'==g.slice(-1)) ? parseFloat(g, 10)*2.55 : parseFloat(g, 10);
            b = ('%'==b.slice(-1)) ? parseFloat(b, 10)*2.55 : parseFloat(b, 10);
            a = parseFloat(a, 10);
            
            c = new Color().fromRGB([r, g, b, a]);

            if ( withColorStops )
            {
                s2 = s.substr( end );
                if ( m2 = s2.match(Color.colorstopRE) )
                {
                    c.colorStop( m2[1] );
                    end2 = m2[0].length;
                }
            }
            return onlyColor ? c : [c, 0, end+end2];
        }
        if ( 'hex' == parsed || 
            ( !parsed && (m = s.match(Color.hexRE)) ) 
        )
        {
            // hex
            if ( 'hex' == parsed )
            {
                var col = hex2rgb( s[0] );
            }
            else
            {
                end = m[0].length;
                end2 = 0;
                var col = hex2rgb( m[1] );
            }    
                
            var h1 = col[0] ? col[0] : 0x00;
            var h2 = col[1] ? col[1] : 0x00;
            var h3 = col[2] ? col[2] : 0x00;
            var a = null!=col[3] ? col[3] : 0xff;
            
            c = new Color().fromHEX([h1, h2, h3, a]);

            if ( withColorStops )
            {
                s2 = s.substr( end );
                if ( m2 = s2.match(Color.colorstopRE) )
                {
                    c.colorStop( m2[1] );
                    end2 = m2[0].length;
                }
            }
            return onlyColor ? c : [c, 0, end+end2];
        }
        if ( 'keyword' == parsed || 
            ( !parsed && (m = s.match(Color.keywordRE)) ) 
        )
        {
            // keyword
            if ( 'keyword' == parsed )
            {
                var col = s[0];
            }
            else
            {
                end = m[0].length;
                end2 = 0;
                var col = m[1];
            }    
                
            c = new Color().fromKeyword(col);

            if ( withColorStops )
            {
                s2 = s.substr( end );
                if ( m2 = s2.match(Color.colorstopRE) )
                {
                    c.colorStop( m2[1] );
                    end2 = m2[0].length;
                }
            }
            return onlyColor ? c : [c, 0, end+end2];
        }
        return null;
    };
    Color.fromString = Color.get = function(s, withColorStops, parsed) {
        return Color.parse(s, withColorStops, parsed, 1);
    };
    Color.fromRGB = function(rgb) {
        return new Color().fromRGB(rgb);
    };
    Color.fromHSL = function(hsl) {
        return new Color().fromHSL(hsl);
    };
    Color.fromCMYK = function(cmyk) {
        return new Color().fromCMYK(cmyk);
    };
    Color.fromHEX = function(hex) {
        return new Color().fromHEX(hex);
    };
    Color.fromKeyword = function(keyword) {
        return new Color().fromKeyword(keyword);
    };
    Color.fromPixel = function(pixCol) {
        return new Color().fromPixel(pixCol);
    };
    //
    // instance
    Color.prototype = {
        
        constructor: Color,
        
        col: null,
        cstop: null,
        kword: null,
        
        clone: function() {
            var c = new Color();
            c.col = this.col.slice();
            c.cstop = this.cstop+'';
            c.kword = this.kword;
            return c;
        },
        
        reset: function() {
            this.col = [0, 0, 0, 1];
            this.cstop = '';
            this.kword = null;
            return this;
        },
        
        set: function(color, cstop) {
            if ( color )
            {
                if ( undef !== color[0] )
                    this.col[0] = clamp(color[0], 0, 255);
                if ( undef !== color[1] )
                    this.col[1] = clamp(color[1], 0, 255);
                if ( undef !== color[2] )
                    this.col[2] = clamp(color[2], 0, 255);
                if ( undef !== color[3] )
                    this.col[3] = clamp(color[3], 0, 1);
                else
                    this.col[3] = 1;
                    
                if (cstop)
                    this.cstop = cstop;
                    
                this.kword = null;
            }
            return this;
        },
        
        colorStop: function(cstop) {
            this.cstop = cstop;
            return this;
        },
        
        isTransparent: function() {
            return 1 > this.col[3];
        },
        
        isKeyword: function() {
            return this.kword ? true : false;
        },
        
        fromPixel: function(color) {
            color = color || 0;
            this.col = [
                clamp((color>>16)&255, 0, 255),
                clamp((color>>8)&255, 0, 255),
                clamp((color)&255, 0, 255),
                clamp(((color>>24)&255)*C2F, 0, 1)
            ];
            this.kword = null;
            
            return this;
        },
        
        fromKeyword: function(kword) {
            
            kword = kword.toLowerCase();
            if ( Color.Keywords[kword] )
            {
                this.col = Color.Keywords[kword].slice();
                this.kword = kword;
            }
            return this;
        },
        
        fromHEX: function(hex) {
            
            this.col[0] = hex[0] ? clamp(parseInt(hex[0], 10), 0, 255) : 0;
            this.col[1] = hex[1] ? clamp(parseInt(hex[1], 10), 0, 255) : 0;
            this.col[2] = hex[2] ? clamp(parseInt(hex[2], 10), 0, 255) : 0;
            this.col[3] = undef!==hex[3] ? clamp(parseInt(hex[3], 10)*C2F, 0, 1) : 1;
            
            this.kword = null;
            
            return this;
        },
        
        fromRGB: function(rgb) {
            
            this.col[0] = rgb[0] ? clamp(round(rgb[0]), 0, 255) : 0;
            this.col[1] = rgb[1] ? clamp(round(rgb[1]), 0, 255) : 0;
            this.col[2] = rgb[2] ? clamp(round(rgb[2]), 0, 255) : 0;
            this.col[3] = undef!==rgb[3] ? clamp(rgb[3], 0, 1) : 1;
            
            this.kword = null;
            
            return this;
        },
        
        fromCMYK: function(cmyk) {
            var rgb = cmyk2rgb(cmyk[0]||0, cmyk[1]||0, cmyk[2]||0, cmyk[3]||0);
            
            this.col[0] = rgb[0];
            this.col[1] = rgb[1];
            this.col[2] = rgb[2];
            this.col[3] = undef!==cmyk[4] ? clamp(cmyk[4], 0, 1) : 1;
            
            this.kword = null;
            
            return this;
        },
        
        fromHSL: function(hsl) {
            var rgb = hsl2rgb(hsl[0]||0, hsl[1]||0, hsl[2]||0);
            
            this.col[0] = rgb[0];
            this.col[1] = rgb[1];
            this.col[2] = rgb[2];
            this.col[3] = undef!==hsl[3] ? clamp(hsl[3], 0, 1) : 1;
            
            this.kword = null;
            
            return this;
        },
        
        toPixel: function(withTransparency) {
            if ( withTransparency )
                return ((clamp(this.col[3]*255, 0, 255) << 24) | (this.col[0] << 16) | (this.col[1] << 8) | (this.col[2])&255);
            else
                return ((this.col[0] << 16) | (this.col[1] << 8) | (this.col[2])&255);
        },
        
        toCMYK: function(asString, condenced, noTransparency) {
            var cmyk = rgb2cmyk(this.col[0], this.col[1], this.col[2]);
            if (noTransparency)
                return cmyk;
            else
                return cmyk.concat(this.col[3]);
        },
        
        toKeyword: function(asString, condenced, withTransparency) {
            if ( this.kword )
                return this.kword;
            else
                return this.toHEX(1, condenced, withTransparency);
        },
        
        toHEX: function(asString, condenced, withTransparency) {
            if ( withTransparency )
                return rgb2hexIE( this.col[0], this.col[1], this.col[2], clamp(round(255*this.col[3]), 0, 255) );
            else
                return rgb2hex( this.col[0], this.col[1], this.col[2], condenced );
        },
        
        toRGB: function(asString, condenced, noTransparency) {
            var opcty = this.col[3];
            if ( asString )
            {
                if ( condenced )
                {
                    opcty =  ((1 > opcty && opcty > 0) ? opcty.toString().slice(1) : opcty );
                }
                
                if ( noTransparency || 1 == this.col[3] )
                    return 'rgb(' + this.col.slice(0, 3).join(',') + ')';
                else
                    return 'rgba(' + this.col.slice(0, 3).concat(opcty).join(',') + ')';
            }
            else
            {
                if ( noTransparency )
                    return this.col.slice(0, 3);
                else
                    return this.col.slice();
            }
        },
        
        toHSL: function(asString, condenced, noTransparency) {
            var opcty = this.col[3];
            var hsl = rgb2hsl(this.col[0], this.col[1], this.col[2]);
            
            if ( asString )
            {
                if ( condenced )
                {
                    hsl[1] = (0==hsl[1] ? hsl[1] : (hsl[1]+'%'));
                    hsl[2] = (0==hsl[2] ? hsl[2] : (hsl[2]+'%'));
                    opcty =  ((1 > opcty && opcty > 0) ? opcty.toString().slice(1) : opcty );
                }
                
                if ( noTransparency || 1 == this.col[3] )
                    return 'hsl(' + [hsl[0], hsl[1], hsl[2]].join(',') + ')';
                else
                    return 'hsla(' + [hsl[0], hsl[1], hsl[2], opcty].join(',') + ')';
            }
            else
            {
                if ( noTransparency )
                    return hsl;
                else
                    return hsl.concat( this.col[3] );
            }
        },
        
        toColorStop: function(compatType) {
            var cstop = this.cstop;
            if ( compatType )
            {
                cstop = cstop.length ? (cstop+',') : '';
                if ( 1 > this.col[3] )
                    return 'color-stop(' + cstop + this.toRGB(1,1) + ')';
                else
                    return 'color-stop(' + cstop + this.toHEX(1,1) + ')';
            }
            else
            {
                cstop = cstop.length ? (' '+cstop) : '';
                if ( 1 > this.col[3] )
                    return this.toRGB(1,1) + cstop;
                else
                    return this.toHEX(1,1) + cstop;
            }
        },
        
        toString: function( format, condenced ) {
            format = format ? format.toLowerCase() : 'hex';
            if ( 'rgb' == format || 'rgba' == format )
            {
                return this.toRGB(1, false!==condenced, 'rgb' == format);
            }
            else if ( 'hsl' == format || 'hsla' == format )
            {
                return this.toHSL(1, false!==condenced, 'hsl' == format);
            }
            else if ( 'keyword' == format )
            {
                return this.toKeyword(1);
            }
            return this.toHEX(1, false!==condenced, 'hexie' == format);
        }
    };
    